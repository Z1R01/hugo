<!DOCTYPE html>
<html lang='en'><head>
  <title>HAproxy Detect Attack |  Zeroday </title>
  <meta charset='utf-8'>
  <meta name="generator" content="Hugo 0.82.0" />
  <meta name = 'viewport' content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no'>
  <meta http-equiv = 'X-UA-Compatible' content = 'IE=edge'>
<meta property = 'og:locale' content = 'en_US' />
<meta property="og:type" content="article">
<meta property = 'og:title' content = 'HAproxy Detect Attack' />
<meta name="description" content="HAproxy ابزاری قدرتمند است که در زمینه load balancing استفاده می شود. اما اگر بتوانید به درستی آن را کانفیگ کنید می توانید بسیاری از حملاتی که در بستر وب به …">
<meta property = 'og:description' content = 'HAproxy ابزاری قدرتمند است که در زمینه load balancing استفاده می شود. اما اگر بتوانید به درستی آن را کانفیگ کنید می توانید بسیاری از حملاتی که در بستر وب به …'>
<meta property = 'og:url' content = 'https://ziroday.ir/post/haproxy-attack/' />
<meta property = 'og:image' content = 'https://ziroday.ir/images/HAProxy.png'/>
<meta name = 'twitter:card' content = 'summary_large_image' />
<meta name = 'twitter:creator' content = ''>
<meta name = 'twitter:title' content = 'HAproxy Detect Attack' />
<meta property = 'twitter:description'  content = 'HAproxy ابزاری قدرتمند است که در زمینه load balancing استفاده می شود. اما اگر بتوانید به درستی آن را کانفیگ کنید می توانید بسیاری از حملاتی که در بستر وب به …'/>
<meta name = 'twitter:image' content = 'https://ziroday.ir/images/HAProxy.png' />
<link rel='apple-touch-icon' sizes='180x180' href='https://ziroday.ir/images/icons/apple-touch-icon.png'>
<link rel='icon' type='image/png' sizes='32x32' href='https://ziroday.ir/images/icons/favicon-32x32.png'>
<link rel='icon' type='image/png' sizes='16x16' href='https://ziroday.ir/images/icons/favicon-16x16.png'>
<link rel='manifest' href='https://ziroday.ir/images/icons/site.webmanifest'>

  <link rel='canonical' href='https://ziroday.ir/post/haproxy-attack/'>
  <link rel = 'stylesheet' href = 'https://ziroday.ir/css/styles.4531cbcd5877eddc9e43fb5754e281c9df181abb3653cd3c64bda43d50abb037c17eea8b1743733d9b651b0b380fec4d53d319000a7ac55940210cb746297dd3.css' integrity = 'sha512-RTHLzVh37dyeQ/tXVOKByd8YGrs2U808ZL2kPVCrsDfBfuqLF0NzPZtlGws4D&#43;xNU9MZAAp6xVlAIQy3Ril90w=='>
</head>

  <body><div class = 'nav-drop'>
  <div class = 'nav-body'>
    
      <a href = 'https://ziroday.ir/about/' class = 'nav_item'>About</a>
      <a href = 'https://ziroday.ir/categories/development/' class = 'nav_item'>Proxmox</a>
      <a href = 'https://ziroday.ir/categories/golang/' class = 'nav_item'>Ansible</a>
      <a href = 'https://ziroday.ir/tags/Ansible/' class = 'nav_item'>Database</a>
    <div class = 'nav-close'></div>
  </div>
</div><header class = 'nav' >
  <nav class = 'nav-menu'>
    <a href='https://ziroday.ir' class = 'nav-brand nav_item'> Zeroday </a>
    <div class = 'nav_bar-wrap'>
      <div class = 'nav_bar'></div>
    </div>
  </nav>
</header>


    <main>

<section class = 'post_header' style = 'background-image:url(https://ziroday.ir/images/HAProxy.png);'>
  <h1 class='post_title'>HAproxy Detect Attack</h1>
</section>
<div class = 'post'>
  <article class='post_content'><p>HAproxy ابزاری قدرتمند است که در زمینه load balancing استفاده می شود. اما اگر بتوانید به درستی آن را کانفیگ کنید می توانید بسیاری از حملاتی که در بستر وب به سرور های شما می شود را با یک کانفیگ صحیح شناسایی کنید و سرورهای خودرا امن نگه دارید.</p>
<p>در این مستند قرار است درباره دستورات و تنظیمات درون HAproxy صحبت کنیم که به شما کمک شایانی برای حفظ امنیت سرورهای خود می کند.</p>
<p>دقت داشته باشید اگر آشنایی با این ابزار ندارید ابتدا به بررسی HAproxy بپردازید سپس ادامه مقاله را مطالعه نمایید.
برای جلوگیری از حملات DDOS در HAproxy می توانیم از آپشن های زیر بهره ببریم که در ادامه هرکدام از آنهارا بررسی میکنیم:</p>
<p><strong>tcp-request , http-request :</strong></p>
<p>پرکاربردترین آپشن جهت برقراری امنیت HA استفاده از این آپشن به همراه پارامترهای آن می باشد که با چند مثال آنهارا بررسی می کنیم.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">frontend mywebsite
    bind *:80
    http-request track-sc0 src table per_ip_rates
</code></pre></div><p>مطابق دستور بالا هر کلاینتی که به سرور ما متصل شود ip آن دنبال شده و داخل جدولی به <strong>per_ip_rates</strong> ذخیره می شود.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">listen Secure_Web_Cluster
bind *:80 transparent
mode http
timeout http-request 5s #Slowloris protection
tcp-request connection accept if { src -f /etc/haproxy/whitelist.lst }
tcp-request content reject if { src -f /etc/haproxy/blacklist.lst }
</code></pre></div><p>مطابق دستور بالا کلاینت ها را به دو دسته سفید و سیاه تقسیم می کنیم و ip هایی که مجاز به اتصال می باشند را در یک لیست تعریف کرده و سپس مجوز دسترسی را در HAproxy برای آنها تعریف میکنیم. به همین ترتیب برای ip هایی که مشکوک هستند نیز می توانیم این کار را انجام دهیم.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">tcp-request connection reject if { src_conn_rate(Abuse) ge 10 }
tcp-request connection reject if { src_conn_cur(Abuse) ge 10 }
tcp-request connection track-sc1 src table Abuse
</code></pre></div><p>اگر کانفیگ بالا را لحاظ نماییم به ip کلاینت کاری ندارد و اگر تعداد درخواست هایش بیش از 10 بار بود و ۱۰ اتصال بیشتر همزمان به سرور داشتیم را reject میکند.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">use_backend bk_web_static if { path_end .jpg .png .gif .css .js }
default_backend bk_web
</code></pre></div><p>گاهی اوقات شما لازم دارید که فایل های استاتیک و از پیش تعریف شده شما مستقیما به یک سرور در بک اند متصل شوند در غیر اینصورت به بک اند دیگری که تعریف کرده اید متصل شوند. با قرار دادن کانفیگ بالا این کار محیاست.</p>
<p>تا بدینجا با کانفیگ های ساده در بهبود امنیت haproxy آشنا شدیم لذا اگر بخواهیم به صورت تخصصی به موضوع بپردازیم و تهدیدات را با الگو خاصی بلاک کنیم دانستن موارد زیر نیز ضروری می باشد.</p>
<p>بلاک کردن درخواست هایی که از پروتکل HTTP_1.0 استفاده می کنند.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">http-request deny if HTTP_1.0
</code></pre></div><p>بلاک کردن درخواست هایی که از طریق مرورگر به سرور متصل نشده اند همچون ابزار curl:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">http-request deny if { req.hdr(user-agent) -i -m sub curl }
</code></pre></div><p>گاهی مهاجم به نحوی درخواست ها را ارسال می کند که user agent ندارد که با دستور زیر می توانید جلوی اینکار را نیز بگیرید:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">http-request deny unless { req.hdr(user-agent) -m found }
</code></pre></div><p>برای جلوگیری از لیستی از agent های مشکوک می توانیم از دستور زیر بهره ببریم:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">http-request deny if { req.hdr(user-agent) -i -m sub -f /etc/haproxy/badagents.acl }
</code></pre></div><p>برای جلوگیری از لیستی از ip های مشکوک می توانیم از دستور زیر بهره ببریم:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">http-request deny if { src -f /etc/hapee-1.8/blacklist.acl }
</code></pre></div><p>از متداول ترین آپشن های دیگر می توانیم به <strong>timeout</strong> و <strong>Maxconn</strong> اشاره کنیم.که با کاهش زمان آنها در بهبود امنیت سرور کمک بسزایی انجام دهیم.</p>

    
    <div class = 'post_extra'><div class = 'copy' data-share = 'Copy' data-copied = 'Copied'><svg>
  <use xlink:href="#copy"></use>
</svg>
</div>

    </div>

    
  </article>
  
  <aside><h3>More from  Zeroday </h3>
<ul class='posts aside'>
<li class = 'post_item'>
  <a class = 'post_card' href='https://ziroday.ir/post/vsftpd/' title = 'Vsftpd Installation' style = 'background-image: url(https://ziroday.ir/images/vsftpd.jpg);'>
  </a>
  <div class = 'excerpt'>
    <div class = 'excerpt_meta'>
      <a href = 'https://ziroday.ir/tags/linux' class = 'post_tag'>Linux
      </a><div class = 'copy' data-share = 'Copy' data-copied = 'Copied'><svg>
  <use xlink:href="#copy"></use>
</svg>
</div>

    </div>
    <h3 class = 'post_link'>
      <a href='https://ziroday.ir/post/vsftpd/'>Vsftpd Installation</a>
    </h3>
    <p class = 'pale'>سرور FTP مخفف (File Transfer Protocol) است كه یک پروتکل شبکه استاندارد بوده و برای انتقال …</p>
  </div>
</li>

<li class = 'post_item'>
  <a class = 'post_card' href='https://ziroday.ir/post/swap/' title = 'Increase Swap' style = 'background-image: url(https://ziroday.ir/images/swap.jpg);'>
  </a>
  <div class = 'excerpt'>
    <div class = 'excerpt_meta'>
      <a href = 'https://ziroday.ir/tags/linux' class = 'post_tag'>Linux
      </a><div class = 'copy' data-share = 'Copy' data-copied = 'Copied'><svg>
  <use xlink:href="#copy"></use>
</svg>
</div>

    </div>
    <h3 class = 'post_link'>
      <a href='https://ziroday.ir/post/swap/'>Increase Swap</a>
    </h3>
    <p class = 'pale'>یه موقع هایی هست که برای انجام کارهای سنگینتون با کامپیوتر رم کم میارید و نیاز شدیدی به …</p>
  </div>
</li>

</ul>

  </aside>
  
</div>
<script src = 'https://ziroday.ir/js/autosize.min.js'></script>
<script src = 'https://ziroday.ir/js/timeago.js'></script>
    </main><svg width="0" height="0" class="hidden">
  <symbol viewBox="0 0 699.428 699.428" xmlns="http://www.w3.org/2000/svg" id="copy">
    <path d="M502.714 0H240.428C194.178 0 153 42.425 153 87.429l-25.267.59c-46.228 0-84.019 41.834-84.019 86.838V612c0 45.004 41.179 87.428 87.429 87.428H459c46.249 0 87.428-42.424 87.428-87.428h21.857c46.25 0 87.429-42.424 87.429-87.428v-349.19zM459 655.715H131.143c-22.95 0-43.714-21.441-43.714-43.715V174.857c0-22.272 18.688-42.993 41.638-42.993l23.933-.721v393.429C153 569.576 194.178 612 240.428 612h262.286c0 22.273-20.765 43.715-43.714 43.715zm153-131.143c0 22.271-20.765 43.713-43.715 43.713H240.428c-22.95 0-43.714-21.441-43.714-43.713V87.429c0-22.272 20.764-43.714 43.714-43.714H459c-.351 50.337 0 87.975 0 87.975 0 45.419 40.872 86.882 87.428 86.882H612zm-65.572-349.715c-23.277 0-43.714-42.293-43.714-64.981V44.348L612 174.857zm-43.714 131.537H306c-12.065 0-21.857 9.77-21.857 21.835s9.792 21.835 21.857 21.835h196.714c12.065 0 21.857-9.771 21.857-21.835 0-12.065-9.792-21.835-21.857-21.835zm0 109.176H306c-12.065 0-21.857 9.77-21.857 21.834 0 12.066 9.792 21.836 21.857 21.836h196.714c12.065 0 21.857-9.77 21.857-21.836 0-12.064-9.792-21.834-21.857-21.834z"
    ></path>
  </symbol>
  <symbol viewBox="0 0 60.015 60.015" xmlns="http://www.w3.org/2000/svg" id="reply">
    <path d="M42.007 0h-24c-9.925 0-18 8.075-18 18v14c0 9.59 7.538 17.452 17 17.973v8.344a1.694 1.694 0 0 0 1.699 1.698c.44 0 .873-.173 1.198-.498l1.876-1.876C26.708 52.713 33.259 50 40.227 50h1.78c9.925 0 18-8.075 18-18V18c0-9.925-8.075-18-18-18zm16 32c0 8.822-7.178 16-16 16h-1.78c-7.502 0-14.556 2.921-19.86 8.226l-1.359 1.359V44a1 1 0 1 0-2 0v3.949c-8.356-.52-15-7.465-15-15.949V18c0-8.822 7.178-16 16-16h24c8.822 0 16 7.178 16 16v14z"></path>
  </symbol>
  <symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="scan">
    <path d="M456.66 0H385c-8.284 0-15 6.716-15 15s6.716 15 15 15h71.66C470.632 30 482 41.368 482 55.341V127c0 8.284 6.716 15 15 15s15-6.716 15-15V55.341C512 24.826 487.174 0 456.66 0zM15 142c8.284 0 15-6.716 15-15V55.341C30 41.368 41.368 30 55.34 30H127c8.284 0 15-6.716 15-15s-6.716-15-15-15H55.34C24.826 0 0 24.826 0 55.341V127c0 8.284 6.716 15 15 15zm112 340H55.34C41.368 482 30 470.632 30 456.659V385c0-8.284-6.716-15-15-15s-15 6.716-15 15v71.659C0 487.174 24.826 512 55.34 512H127c8.284 0 15-6.716 15-15s-6.716-15-15-15zm370-112c-8.284 0-15 6.716-15 15v71.659C482 470.632 470.632 482 456.66 482H385c-8.284 0-15 6.716-15 15s6.716 15 15 15h71.66c30.515 0 55.34-24.826 55.34-55.341V385c0-8.284-6.716-15-15-15zM341.643 110h47.575c6.497 0 11.782 5.285 11.782 11.782v47.574c0 8.284 6.716 15 15 15s15-6.716 15-15v-47.574C431 98.743 412.256 80 389.218 80h-47.575c-8.284 0-15 6.716-15 15s6.716 15 15 15zM81 121.782v47.574c0 8.284 6.716 15 15 15s15-6.716 15-15v-47.574c0-6.497 5.286-11.782 11.782-11.782h47.575c8.284 0 15-6.716 15-15s-6.716-15-15-15h-47.575C99.744 80 81 98.743 81 121.782zM170.357 400h-47.575c-6.497 0-11.782-5.285-11.782-11.782v-47.574c0-8.284-6.716-15-15-15s-15 6.716-15 15v47.574C81 411.257 99.744 430 122.782 430h47.575c8.284 0 15-6.716 15-15s-6.716-15-15-15zM431 388.218v-47.574c0-8.284-6.716-15-15-15s-15 6.716-15 15v47.574c0 6.497-5.286 11.782-11.782 11.782h-47.575c-8.284 0-15 6.716-15 15s6.716 15 15 15h47.575C412.256 430 431 411.257 431 388.218zM1 256c0 8.284 6.716 15 15 15h480c8.284 0 15-6.716 15-15s-6.716-15-15-15H16c-8.284 0-15 6.716-15 15z"></path>
  </symbol>
</svg>
<footer class="footer">
  <div class="footer_inner wrap pale">
    <p>&copy;&nbsp;<span class="year"></span>&nbsp; Zeroday .
    Designed by  <a href = 'https://www.linkedin.com/in/mhdbkhshi/' title = 'Linkedin Profile'>M.bakhshi</a></p>
  </div>
</footer><script type="text/javascript" src="https://ziroday.ir/js/bundle.5e0b4c85114cf0b04ee873e699248fdc25fe576c7696dfa64e769392358047c54a5d3cd146642878b99a54694bfafde61088d7a1e98279124e539098db6e557e.js" integrity="sha512-XgtMhRFM8LBO6HPmmSSP3CX&#43;V2x2lt&#43;mTnaTkjWAR8VKXTzRRmQoeLmaVGlL&#43;v3mEIjXoemCeRJOU5CY225Vfg==" crossorigin="anonymous"></script>
  </body>
</html>
